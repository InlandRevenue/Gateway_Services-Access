![IRD logo](../../Images/IRlogo.gif)
![Software Dev](../../Images/SoftwareDev.png)

# Message Samples - OAuth Requests and Responses

##### Table of Contents
* [URL EndPoint Parameter](#URLEndPointParameter) 
* [Request Authorisation Code](#RequestAuthorisationCode)
* [Exchange Authorisation Code for an Authorisation Token](#ExchangeAuthorisationCodeforanAccessToken)
* [Request Refresh Token](#RequestRefreshToken)
* [Validate Access Token](#ValidateAccessToken)
* [Revoke Token Request](#RevokeTokenRequest)
* [Error Response](#ErrorResponse)


<a name="URLEndPointParameter"/>

## URL Endpoint Parameter:

#### Parameters:
```{ServiceHostDomain}```: this is IR's Gateway Service environment specific domain that is accessed after your endpoint IP / CIDR range is white-listed.

|Environment |```{ServiceHostDomain}``` Hostname |
|-|-|
| Mock (DPS) | ```https://mock-oauth.ird.digitalpartner.services``` |
| Test (DTE) | ```https://test4.services.ird.govt.nz``` |
| Production | ```https://services.ird.govt.nz```  |

>Note:
>
>These hostnames are subject to change. 

<a name="RequestAuthorisationCode" />

## Request Authorisation Code:

Software Provider will send a ```HTTP GET``` request via a Browser to Authorisation Server. 

#### URL format:

```http
https://{ServiceHostDomain}/ms_oauth/oauth2/endpoints/oauthservice/authorize
 ?client_id=xyzComp_FooBar
 &redirect_uri=https://mycompdomain.com/returnpath/oAuthCallBack
 &scope=MYIR.Services
 &response_type=code
 &state=2d0fcc2d-8f7a-4f27-8bea-976cb86bd409
 &logout=true
```

Here’s each query parameter explained:
* ```client_id```: The public identifier (ClientID) for the application which is obtained from the onboarding team. 
* ```redirect_uri```: Tells the authorization server where to send the user back to after they approve the request.
* ```scope```: ```MYIR.Services```, strings indicating which permissions the application is requesting. 
* ```grant_type```: ```authorisation_code``` This tells the token endpoint that the application is using the Authorization Code grant type.
* ```state```: **Recommended.** The software provider's application generates a random string and includes it in the request. It should then check that the same value is returned after the user authorises the app. 
* ```logout```: **Optional.** To enable a user to use a different myIR login, setting the value to ```“true”``` will force the logout of any user currently logged in. This avoids having to close a browser or wait 15 minutes to timeout an existing user login. 
This will force the re-display of the login page and request the input of a new myIR account to login. The value of ```“false”``` or absence of this 
parameter will not force logout. 

When the user visits this URL, the authorization server will present them with a login prompt asking if they would like to authorise this application’s request.
The user will be asked to "Authorise Consent" for the very first login.

> Note: 
> * Keep the state parameter less than 200 characters long. 
> * The ```state``` parameter can include the following characters:
>     * ```a-z```
>	   * ```A-Z```
>	   * ```0-9```
>     * ```- . ? , : ' / \ + = $ #_``` 
>     * The ```space ``` character (ASCII 32, %20) should also be avoided. 


<a name="RedirectBacktotheApplication" />

#### Successful Redirect Back to the Application:

If the user approves the request, the authorisation server will redirect the browser back to the redirect_uri specified by the application, adding a code and state to the query string.

For example, the user will be redirected back to a URL such as:
```http
https://mycompdomain.com/returnpath
 ?code=eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXV...hrNZYDZbakOpz4uY6UlSSNECmw0ac8
 &state=2d0fcc2d-8f7a-4f27-8bea-976cb86bd409
```
The ```state``` value will be the same value that the application initially set in the request. The application is expected to check that the state in the redirect matches the state it originally set. 
The ```code``` is the authorization code generated by the authorization server. 
>Note: This code is relatively short-lived, typically lasting only 15 minutes.

<a name="ExchangeAuthorisationCodeforanAccessToken"/>

## Exchange Authorisation Code for an Access Token

Now that the application has the authorization code, it can use that to get an access token.

At this step the Software Provider needs to send a **HTTP POST** request to Auth Server with Authorization Code and your client credentials.

Form Fields:

* ```code```:  The application includes the authorization code it was given in the redirect.
* ```redirect_uri```:  The URL must match exactly the redirect_uri passed to `/ms_oauth/oauth2/endpoints/oauthservice/authorize`
* ```grant_type``` - This must be ```authorization_code```

The HTTP Header must include a Authorization header: ```"Basic " + Base64Encode( ClientID + ':' + ClientSecret)```: 

```http 
Authorization: Basic eHl6Q29tcF9Gb29CYXI6Q2xpZW50U2VjcmV0UGFzc3dvcmQ=
```
### Example POST request:
```http
POST /ms_oauth/oauth2/endpoints/oauthservice/tokens HTTP/1.1
Host: {ServiceHostDomain}
Content-Type: application/x-www-form-urlencoded
Authorization: Basic eHl6Q29tcF9Gb29CYXI6Q2xpZW50U2VjcmV0UGFzc3dvcmQ= 

redirect_uri=https://mycompdomain.com/returnpath
&code=eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCIsIng1dCI6In...-VMbr_hrNZYDZbakOpz4uY6UlSSNECmw0ac8
&grant_type=authorization_code
```

The token endpoint will verify all the parameters in the request, ensuring the 
code hasn’t expired and that the Client ID and Client Secret match. If everything checks out, it will generate an access token and return it in the response!

### Example of a successful token exchange: 
```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "expires_in":28800,
  "token_type":"Bearer",
  "access_token":"MTQ0NjJkZmQ5OTM2...NDE1ZTZjNGZmZjI3",
  "refresh_token":"IwOGYzYTlmM2YxOT...Q5MGE3YmNmMDFkNTVk"
}
```

### Example of a failed token exchange:
```http
HTTP/1.1 401 Unauthorized
Content-Type: application/json

{
   "error": "invalid_grant",
   "error_description": "Invalid Grant: grant_type=refresh_token"
}
```

The Authorisation Code flow is complete! The application now has an access token it can use when making requests thought the gateway services.

### Get Auth Token using cURL:

```php
curl --verbose --request POST \
  --user "{ClientID}:{ClientSecret}"
  --url "https://{ServiceHostdomain}/ms_oauth/oauth2/endpoints/oauthservice/tokens" \
  --header "content-type: application/x-www-form-urlencoded" \
  --data "grant_type=authorization_code&redirect_uri=https%3A%2F%2Ftestpartner.ird.services%2F" \
  --output token.txt 
```

>Note:
>
> The OAuth Access Token has a time to live of 8 hours.  

<a name="RequestRefreshToken"/>

## Request Refresh Token

In normal use it is expected that the Access Token will be re-used while it is active and the 
client will make several calls using this Access Token. If the Access Token has expired, the client can request another Access Token using the Refresh Token and client credentials. 
The Refresh Token is granted as part of the Cloud Authorisation Service, the client will need to 
hold this and when required can be exchanged for a new Access and Refresh Token granting 
longer term use.  

Form Fields:

* ```grant_type```:  The grant type is required and takes the value ```refresh_token``` 
* ```refresh_token```:  The refresh_token field contains the Refresh Token 

The HTTP Header must include a Authorization header: ```"Basic " + Base64Encode( ClientID + ':' + ClientSecret)```: 
```http 
Authorization: Basic eHl6Q29tcF9Gb29CYXI6Q2xpZW50U2VjcmV0UGFzc3dvcmQ=
```
### Example POST request:
```http
POST /ms_oauth/oauth2/endpoints/oauthservice/tokens HTTP/1.1
Host: {ServiceHostDomain}
Content-Type: application/x-www-form-urlencoded
Authorization: Basic eHl6Q29tcF9Gb29CYXI6Q2xpZW50U2VjcmV0UGFzc3dvcmQ= 

grant_type=refresh_token
&refresh_token=IwOGYzYTlmM2YxOTiojsd098sdjowe08f450j87j98sf497...8h6af49j876ase45gj0789das45d089j
```

### Example of a successful token refresh:
```http
HTTP/1.1 200 OK
Content-Type: application/json

{
   "expires_in": 28800,
   "token_type": "Bearer",
   "access_token": "eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCIsIng1d...CJWXfilfHJVuRchenyW4Lv8sVTKGPbQOQ",
   "refresh_token": "eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCIsIng1dCI6Ino...LWcOM33Htc9SHHOjglMNzyTl76-yq1F4TU3eueAG8",
}
```

>Note:
>
>* Refresh token last up to 6 months.
>* The OAuth Refresh Access Token has a time to live of 6 months. 

<a name="ValidateAccessToken"/>

## Validate Access Token

This service will Validate an Access Token. Once your Application receives a request with a Bearer Access Token, the first thing you can do is to validate the token.

Form Fields:

* ```grant_type```: is ```oracle-idm:/oauth/grant-type/resource-access-token/jwt```
* ```oracle_token_action```: is ```validate```
* ```scope```: is ```MYIR.Services```  
* ```assertion```: - _current access/refresh token_
* ```oracle_token_attrs_retrieval```: is ```prn exp```

### Example POST request to Validate a Access Token:

```http
POST /ms_oauth/oauth2/endpoints/oauthservice/tokens HTTP/1.1
Host: {ServiceHostDomain}
Content-Type: application/x-www-form-urlencoded
Authorization: Basic eHl6Q29tcF9Gb29CYXI6Q2xpZW50U2VjcmV0UGFzc3dvcmQ= 

grant_type=oracle-idm:/oauth/grant-type/resource-access-token/jwt
&oracle_token_action=validate
&scope=MYIR.Services
&assertion=eyJhbGciOiJSUzUxMiIsInR5cCI...S4SfeEm6s1iN46QldbunwYM
&oracle_token_attrs_retrieval=prn exp
```

### Example of a successful response:

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
   "successful": true,
   "oracle_token_attrs_retrieval": {
      "exp": 1519367910,
      "prn": "Client008"
   }
} 
```
<a name="RevokeTokenRequest"/>

## Revoke Token Request

A token revoke process is available that will allow the client to revoke the acquired access token or refresh token. This is used to enable a "log out" feature in clients, allowing the authorisation server to clean up any security credentials associated with the authorisation.

Form Fields:

* ```grant_type```: is ```oracle-idm/oauth/grant-type/resource-access-token/jwt```
* ```oracle_token_action```:  is ```delete```
* ```assertion```: - _current access/refresh token_  

### Example POST request to Revoke an Access Token:

```http
POST /ms_oauth/oauth2/endpoints/oauthservice/tokens HTTP/1.1
Host: {ServiceHostDomain}
Content-Type: application/x-www-form-urlencoded
Authorization: Basic eHl6Q29tcF9Gb29CYXI6Q2xpZW50U2VjcmV0UGFzc3dvcmQ= 

grant_type=oracle-idm:/oauth/grant-type/resource-access-token/jwt
&oracle_token_action=delete
&assertion=eyJhbGciOiJSUzUxMiIsInR5cC...kG0ur2SGdTnjHFyXFoleoU
```

### Example successful response:
```http
HTTP/1.1 200 OK
Content-Type: application/json

{
   “successful”:true
}
```

### Example failed responses:
```http
HTTP/1.1 400 Bad Request
Content-Type: application/json

{
   "error": "invalid_grant",
   "error_description": "Cannot terminate invalid token."
}
```

```http
HTTP/1.1 400 Bad Request
Content-Type: application/json

{
   "error": "invalid_request",
   "error_description": "Invalid token action: deleted"
}
```

<a name="ErrorResponse"/>

## Error Response:

If validation errors are found, a JSON response containing error codes and descriptions is sent. Following are some error codes and their descriptions: 

|HTTP code |Error Type  |Description |
|:---:|-|-|
|400 Bad Request / 401 Unauthorized |```invalid_redirect_uri```  |Redirect URI mismatch with Software Provider's app  | 
| |```Invalid client ID```  |API Key contains invalid information  |
| |```Invalid client_id or client_secret```  |API Secret contains invalid information  |
| |```invalid_client```  | Business partner identifier invalid  |
| |```invalid_scope```  |Requested scope is invalid, unknown, or malformed  | 
| | ```server_error```  |Authentication - Runtime processing error  |
| | ```access_denied``` |End-user denied authorisation  |
| 500 Internal Server Error| ```InternalError```  |An internal and unexpected error occurred   |
| 504 Gateway Timeout | ```GatewayError```  |Gateway did not receive a timely response from the upstream server  |