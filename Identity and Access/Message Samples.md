![IRD logo](../Images/IRlogo.gif)
![Software Dev](../Images/SoftwareDev.png)

# Message Samples - OAuth Requests and Responses

#### OAuth2 changes as of the 10th October 2022
* New URL Endpoints
* PKCE support
* MFA Multi Factor Authentication 
* Rotating Refresh Tokens 

[Old Oracle xIAMS OAuth Service](Archive/20200112%20v2.8/Message%20Samples%20-%20Oracle%20xIAMS.md)

##### Table of Contents
* [URL EndPoint Parameter](#URLEndPointParameter) 
* [Request Authorisation Code](#RequestAuthorisationCode)
* [Exchange Authorisation Code for an Authorisation Token](#TokenExchange)
* [Refresh Access Token](#RefreshAccessToken)
* [Validate Access Token](#ValidateAccessRefreshToken) (Introspection)
* [Revoke Token Request](#RevokeTokenRequest) (Revocation)

<a name="URLEndPointParameter"/>

## URL Endpoint Parameter:

#### Parameters:
```{ServiceHostDomain}```: this is IR's Gateway Service environment specific domain.

|Environment |```{ServiceHostDomain}``` Hostname |
|-|-|
| Mock (DPS) | ```https://oauth.test.services.ird.govt.nz``` |
| Test (DTE) | ```https://test5.services.ird.govt.nz``` |
| Production | ```https://services.ird.govt.nz```  |

>Note:
>
>These hostnames are subject to change. 

---

<a name="RequestAuthorisationCode" />

## Request Authorisation Code:

Software Provider will send a HTTP ```GET``` request via a Browser to Authorisation Service. 

#### URL format:

```http
https://{ServiceHostDomain}/gateway3/oauth/authorize
 ?client_id=xyzComp_FooBar
 &redirect_uri=https://mycompdomain.com/returnpath/oAuthCallBack
 &scope=MYIR.Services
 &response_type=code
 &state=2d0fcc2d-8f7a-4f27-8bea-976cb86bd409
 ```

Here’s each query parameter explained:
* ```client_id```: The public identifier (ClientID) for the application which is obtained from the onboarding team. 
* ```redirect_uri```: Tells the authorization server where to send the user back to after they approve the request.
* ```scope```: ```MYIR.Services```, strings indicating which permissions the application is requesting. 
* ```response_type```:```code```, Response type requested.
* ```state```: **Recommended.** The software provider's application generates a random string and includes it in the request. It should then check that the same value is returned after the user authorises the app. 

When the user visits this URL, the authorization server will present them with a login prompt asking if they would like to authorise this application’s request.
The user will be asked to "Authorise Consent" for the very first login.

> Note: 
> * Keep the state parameter less than 200 characters long. 
> * The ```state``` parameter can include the following characters:
>     * ```a-z```
>	   * ```A-Z```
>	   * ```0-9```
>     * ```- . ? , : ' / \ + = $ #_``` 
>     * The ```space ``` character (ASCII 32, %20) should also be avoided. 


<a name="RedirectBacktotheApplication" />

#### Successful Redirect Back to the Application:

If the user approves the request, the authorisation server will redirect the browser back to the redirect_uri specified by the application, adding a code and state to the query string.

For example, the user will be redirected back to a URL such as:
```http
https://mycompdomain.com/returnpath
 ?code=T3BhcXVlVmFsdWVPcGFxdWVWYWx1ZU9wYXF1ZVZhbHVlT3BhcXVlVmFsdWVPcGFxdWVWYWx1ZU9wYXF1ZVZhbHVlT
 &state=2d0fcc2d-8f7a-4f27-8bea-976cb86bd409
```
The ```state``` value will be the same value that the application initially set in the request. The application is expected to check that the state in the redirect matches the state it originally set. 
The ```code``` is the authorization code generated by the authorization server. 
>Note: 
>
>The Authorization Code is relatively short-lived, typically lasting only 10 minutes.

---

<a name="TokenExchange"/>

## Exchange Authorisation Code for an Access Token

Now that the application has the authorization code, it can use that to get an access token.

At this step the Software Provider needs to send a HTTP ``POST`` request to Auth Server with Authorization Code and your client credentials.

Form Fields:

* ```code```:  The application includes the authorization code it was given in the redirect.
* ```redirect_uri```:  The URL must match exactly the redirect_uri passed to `/gateway3/oauth/authorize`
* ```grant_type```: This must be```authorization_code``` This tells the token endpoint that the application is using the Authorization Code grant type.

The HTTP Header must include a Authorization header: ```"Basic " + Base64Encode( ClientID + ':' + ClientSecret)```: 

```http 
Authorization: Basic eHl6Q29tcF9Gb29CYXI6Q2xpZW50U2VjcmV0UGFzc3dvcmQ=
```
### Example POST request:
```http
POST /gateway3/oauth/token HTTP/1.1
Host: {ServiceHostDomain}
Content-Type: application/x-www-form-urlencoded
Authorization: Basic eHl6Q29tcF9Gb29CYXI6Q2xpZW50U2VjcmV0UGFzc3dvcmQ= 

redirect_uri=https://mycompdomain.com/returnpath
&code=T3BhcXVlVmFsdWVPcGFxdWVWYWx1ZU9wYXF1ZVZhbHVlT3BhcXVlVmFsdWVPcGFxdWVWYWx1ZU9wYXF1ZVZhbHVlT-VMbr_hrNZYDZbakOpz4uY6UlSSNECmw0ac8
&grant_type=authorization_code
```

The token endpoint will verify all the parameters in the request, ensuring the 
code hasn’t expired and that the Client ID and Client Secret match. If everything checks out, it will generate an access token and return it in the response!

### Example of a successful token exchange: 
```http
HTTP/1.1 200 OK
Content-Type: application/json

{
	"access_token": "eyJhbGciOiJSUzUxMiIsInR5cCI6ImF0LUpXVCIsImtpZCI6IkM1NkIwREM1NkE5QjYwOTU0NkZEMjI4NjJDRUYxMUE3RTUwQjU0ODUifQ.eyJuYmYiOjE2NTgxMTYxMzUsImp0aSI6Ijg3NGE3ZDEzLWUzZGYtNDMxNC1iODIzLWZkZDExMGZjNzVkMCIsImlzcyI6Imh0dHBzOlwvXC90ZXN0MS5zZXJ2aWNlcy5pcmQuZ292dC5uelwvZ2F0ZXdheTNcL29hdXRoXC8iLCJpYXQiOjE2NTgxMTY0MzUsInN1YiI6IjU0NTM3OGZjLTYwZmUtNGE4OC1iNjM4LTEyYTU5NTBhMjIwMSIsInN0YXJ0TG9nb24iOiJUb21Ub20xMjMiLCJzY29wZSI6Ik1ZSVIuU2VydmljZXMiLCJjbGllbnRpZCI6Inhlcm8iLCJhdWQiOiJodHRwczpcL1wvdGVzdDEuc2VydmljZXMuaXJkLmdvdnQubnpcL2dhdGV3YXkzXC9vYXV0aFwvIiwiZ3JhbnQiOiJSRUZSRVNIX1RPS0VOIiwiZXhwIjoxNjU4MTQ1MjM1fQ.I3zpluLG0U1-SG5cWGD_L-n-61aLC6CA1mr8yzvrUDIS_EcenBw9YNNLyJmcRUtueh646mXq4nE3pcdCv5Z6nLazWxeSHneY9er77yKz7gp2arDJawTfY7Xe2ZqnaPR3L32R5JQagsEM-UFd4vPOolI8BuyiemVhUTAQ9hmFscYuQ92XH6xaQQ3dU9TEtIjRSg0wv04a0Xbwvnh3Wv263hU7Z8sduOkjrYcyIsCz_FhP3X1FTEVFecOpK1jnfGOfqgNGkZO5sKl81DWtbfAbt5jJ4tP7tnwNXy-4kCYD3U9rINfoh4f9KoGO2QNXw8mkjJCy1kWacgX8dGC559-TXg",
	"token_type": "Bearer",
	"expires_in": "28800",
	"scope": "MYIR.Services",
	"refresh_token": "jdjwx6rkdkrz73dxc6nwk7zmmcnjvjzttp3854t2b4khq4frrz"
}
```

### Example of a failed token exchange:
```http
HTTP/1.1 401 Unauthorized
Content-Type: application/json

{
   "error": "invalid_grant",
   "error_description": "Invalid authorization code."
}
```

The Authorisation Code flow is complete! The application now has an access token it can use when making requests thought the gateway services.

### Get Auth Token using cURL:

```php
curl --verbose --request POST \
  --user "{ClientID}:{ClientSecret}"
  --url "https://{ServiceHostdomain}/gateway3/oauth/token" \
  --header "content-type: application/x-www-form-urlencoded" \
  --data "grant_type=authorization_code&redirect_uri=https%3A%2F%2Ftestpartner.ird.services%2F" \
  --output token.txt 
```

>Note:
>
> The OAuth Access Token has a time to live of 8 hours.  

---

<a name="RefreshAccessToken"/>

## Refresh Access Token

In normal use it is expected that the Access Token will be re-used while it is active and the client will make several calls using this Access Token. If the Access Token has expired, the client can request another Access Token using the Refresh Token and client credentials.

The Refresh Token is granted as part of the Cloud Authorisation Service (non-Native Desktop), the client will need to 
store this rotating Refresh Token and when required can be exchanged for a new Access.  

Form Fields:

* ```grant_type```:  The grant type is required and takes the value ```refresh_token``` 
* ```refresh_token```:  The refresh_token field contains the Refresh Token 

The HTTP Header must include a Authorization header: ```"Basic " + Base64Encode( ClientID + ':' + ClientSecret)```: 
```http 
Authorization: Basic eHl6Q29tcF9Gb29CYXI6Q2xpZW50U2VjcmV0UGFzc3dvcmQ=
```

### Example POST request:

```http
POST /gateway3/oauth/token HTTP/1.1
Host: {ServiceHostDomain}
Content-Type: application/x-www-form-urlencoded
Authorization: Basic eHl6Q29tcF9Gb29CYXI6Q2xpZW50U2VjcmV0UGFzc3dvcmQ= 

grant_type=refresh_token
&refresh_token=IwOGYzYTlmM2YxOTiojsd098sdjowe08f450j87j98sf497...8h6af49j876ase45gj0789das45d089j
```

### Example of a successful token refresh:
```http
HTTP/1.1 200 OK
Content-Type: application/json

{
   "expires_in": 28800,
   "token_type": "Bearer",
   "access_token": "eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCIsIng1d...CJWXfilfHJVuRchenyW4Lv8sVTKGPbQOQ",
   "refresh_token": "T3BhcXVlVmFsdWVP...GFxdWVWYWx1ZU9wYX",
}
```

>Note:
>
>* The Refresh Token can only be used once.
>* The Refresh Token has a time to live of 12 months. 

---

<a name="ValidateAccessRefreshToken"/>

## Validate Access/Refresh Token (Intropection)

This service will validate an Access/Refesh Token. Once your Application receives a request with a Bearer Access Token, the first thing you can do is to validate the token.

vForm Fields:

* ```token_type_hint```:  is ```access_token | refresh_token```
* ```token```:  _current access token_ | _current refresh token_

### Example POST request to Validate a Access Token:

```http
POST /gateway3/oauth/introspect HTTP/1.1
Host: {ServiceHostDomain}
Content-Type: application/x-www-form-urlencoded
Authorization: Basic eHl6Q29tcF9Gb29CYXI6Q2xpZW50U2VjcmV0UGFzc3dvcmQ= 

&token_type_hint=access_token
&token=eyJhbGciOiJSUzUxMiIsInR5cCI...S4SfeEm6s1iN46QldbunwYM
```

### Example of a successful response:

Successful responses will return HTTP Status code `200` with a JSON response.

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
	"active": true,
	"client_id": "clientID",
	"username": "myIRUsername",
	"scope": "MYIR.Services",
	"sub": "545378fc-60fe-4a88-b638-12a5950a2201",
	"exp": 1658144943,
	"iat": 1658116143
}
```

---

<a name="RevokeTokenRequest"/>

## Revoke Token Request (Revocation)

A token revoke process is available that will allow the client to revoke the acquired access token or refresh token. This is used to enable a "log out" feature in clients of if the token has been compromised, allowing the authorisation server to clean up any security credentials associated with the authorisation.

#### Form Fields:

* ```token_type_hint```:  is ```access_token | refresh_token```
* ```token```:  _current access token_ | _current refresh token_

### Example POST request to Revoke an Access/Refresh Token:

```http
POST /gateway3/oauth/revoke HTTP/1.1
Host: {ServiceHostDomain}
Content-Type: application/x-www-form-urlencoded
Authorization: Basic eHl6Q29tcF9Gb29CYXI6Q2xpZW50U2VjcmV0UGFzc3dvcmQ= 

&token_type_hint=access_token
&token=eyJhbGciOiJSUzUxMiIsInR5cC...kG0ur2SGdTnjHFyXFoleoU
```

### Example successful response:
Successful responses will return HTTP Status code `200` with no content.